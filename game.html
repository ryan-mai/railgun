<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Railgun</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script src="shader-grid-glitch.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="firebase-config.js"></script>

  </head>
  <body>
    <script>
      document.documentElement.classList.add('auth-pending');
      try {
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.onAuthStateChanged((user) => {
          const sceneEl = document.querySelector('#scene');
          console.log('onAuthStateChanged -> user:', user);
          console.log('firebase.auth().currentUser:', firebase.auth().currentUser);
          console.log('localStorage before handling:', {
            playerLoggedIn: localStorage.getItem('playerLoggedIn'),
            playerName: localStorage.getItem('playerName'),
            playerRank: localStorage.getItem('playerRank'),
            playerScore: localStorage.getItem('playerScore'),            
          });
          if (!user) {
            console.log('No authenticated user detected — redirecting to login.html');
            try { localStorage.removeItem('playerLoggedIn'); } catch (e) {}
            window.location.href = 'login.html';
            return;
          }
          try {
            localStorage.setItem('playerLoggedIn', 'true');
            const providedName = user.displayName || user.email;
            if (providedName) {
              localStorage.setItem('playerName', providedName);
            }
          } catch (e) {}
          console.log('Authenticated — stored player info:', {
            playerLoggedIn: localStorage.getItem('playerLoggedIn'),
            playerName: localStorage.getItem('playerName'),
            playerScore: localStorage.getItem('playerScore'),
            playerRank: localStorage.getItem('playerRank'),
            uid: user.uid
          });
          if (sceneEl) sceneEl.style.visibility = 'visible';
          document.documentElement.classList.remove('auth-pending');
        });
      } catch (e) {
        console.warn('Firebase init failed or already initialized.', e);
        // If Firebase is unavailable, allow scene for local testing
        const sceneEl = document.querySelector('#scene');
        if (sceneEl) sceneEl.style.visibility = 'visible';
        document.documentElement.classList.remove('auth-pending');
      }
      AFRAME.registerComponent('timer', {
        schema: {
          duration: {type: 'number', default: 61}
        },
        init: function() {
          this.timeLeft = this.data.duration;
          this.timerEl = this.el;
          this.interval = setInterval(() => {
            if (this.timeLeft > 0) {
              this.timeLeft--;
              this.timerEl.setAttribute('troika-text', {value: `${this.timeLeft}s`});
            } else {
              clearInterval(this.interval);
              location.reload();
            }
          }, 1000);
        },
        remove: function() {
          clearInterval(this.interval);
        }
      });
      AFRAME.registerComponent('updateScore', {
        schema: {
          target: { type: 'selector', default: '#score' },
          base: { type: 'number', default: 0 }
        },
        init: function () {
          this.score = this.data.target;
        },
        tick: function () {
          this.el.addEventListener
          this.score.object3D.position.x = this.data.baseX + playerX;
        }
      });
      function getRnd(min, max) {
        return Math.floor(Math.random() * (max - min) ) + min;
      }
AFRAME.registerComponent('clickable', {
  schema: {
    score: { type: 'number', default: 0 },
  },
  init: function () {
    var target = document.querySelector('#target');
    var scoreEl = document.querySelector('#score');
    var scoreValue = 0;

    var lastIndex = -1;
    var COLORS = ['red', 'green', 'blue'];
    this.el.addEventListener('click', function (evt) {
      lastIndex = (lastIndex + 1) % COLORS.length;
      this.setAttribute('material', 'color', COLORS[lastIndex]);
      target.object3D.position.x = getRnd(-5,5);
      target.object3D.position.y = getRnd(-5,5);
      scoreValue += 1;
      scoreEl.setAttribute('troika-text', {value: `Score: ${scoreValue}`});
      console.log('Hit At: ', evt.detail.intersection.point);
    });
  }
});
      AFRAME.registerComponent('aimbot', {
        init: function () {
          this.el.addEventListener('click', function (evt) {
            var aimbot = document.querySelector('#aimbot')
            aimbot.setAttribute('text', {value: `AIMBOT ON`})

            setTimeout(() => {
              console.log('AIMBOT ACTIVATED!!! :)')
              aimbot.setAttribute('text', {value: `:))) BYEEE!!`})
              location.reload();
            }, 4000);
          });
        }
      });
    document.addEventListener('DOMContentLoaded', function() {
      var sceneEl = document.querySelector('a-scene');
      var reticleEl = document.querySelector("#ret");
      var rayEl = document.querySelector("ray");
    });
    

    </script>
  <a-scene id="scene" stats style="visibility: hidden;">

        <a-assets>
            <img id="leaderboard" src="assets/images/leaderboard.png">
          <a-asset-item id="map" src="assets/models/city.glb"></a-asset-item>
          <a-asset-item id="sinon" src="assets/models/sinon_sniping.glb"></a-asset-item>
          <a-asset-item id="ball" src="assets/models/ball.glb"></a-asset-item>
          <audio id="sao_op" src="assets/sounds/sao_op.mp3" preload="auto"></audio>
          <audio id="shoot" src="assets/sounds/gunshot.mp3" preload="auto"></audio>
          <img id="reticle" src="assets/images/reticle.png">
          <img id="score_bg" src="assets/images/score.png">
          <img id="timer_bg" src="assets/images/timer.png">
          <a-asset-item id="futura" src="assets/fonts/futura_v2.ttf"></a-asset-item>

        </a-assets>

        <a-entity sound="src: #sao_op"></a-entity> 
        <a-entity gltf-model="#map" position="1.6 -50 -0.8" rotation="0 200 0" scale="1 1 1"></a-entity>
        <a-sky color="#000"></a-sky>
        <a-plane class="aimbot" aimbot width="2" height="0.5" position="0 -5 -3" rotation="-75 0 0">
          <a-entity id="aimbot" troika-text="value: aimbot; font: #futura; color: black; fontSize: 0.2; anchor: center" position="0 0 0"></a-entity>
        </a-plane>
        <a-entity id="target" class="clickable" clickable  geometry="primitive: sphere; radius: 0.25" material="shader:grid-glitch;"  position="0 0 -4" radius="0" sound="src: #shoot; volume= 2.0; on: click"></a-entity>
        <a-entity id="player"
            position-reader
            nipple-controls="mode: static">
        <a-entity
            camera
            position="0 0.9 0"
            look-controls="true">
            <a-image id="timer_plane" src="#timer_bg" width="4" height="1" position="0.0 3.25 -5">
                <a-entity id="time" timer troika-text="value: 60s; font: #futura; color: #fff; anchor: center; fontSize: 0.35" position="0 -0.3 0.5"></a-entity>
            </a-image>
            <a-image id="score_plane" src="#score_bg" width="3" height="1" position="7.0 3.25 -5">
              <a-entity id="score" troika-text="value: Score: 0; font: #futura; fontSize: 0.35; color: #fff; anchor: center" position="-0.7 -0.3 0.5">
              </a-entity>
            </a-image>
            <a-entity gltf-model="#sinon" animation-mixer="loop: repeat;" position="0 -1 0" scale="2 2 2" rotation="0 180 0"></a-entity>
            <a-entity
              id="ray"
              cursor="fuse: true;"
              raycaster="showLine: true; far: 50; lineColor: red; interval: 500; objects: .clickable, .aimbot;"
              material="color: red; shader: flat"
              position="0 0 0"
              rotation="0 0 0">

              <a-image id="ret" src="#reticle"
                      position="0 0 -10"
                      width="2.5"
                      height="2.5"
                      rotation="0 0 0"
                      material="src: #reticle; transparent: true; alphaTest: 0.01; depthTest: false;">
              </a-image>
            </a-entity>
          </a-entity>
        </a-entity>
    </a-scene>
  </body>
</html>