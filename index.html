<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Railgun</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script src="shader-grid-glitch.js"></script>
  </head>
  <body>
    <script>
      AFRAME.registerComponent('updateScore', {
        schema: {
          target: { type: 'selector', default: '#score' },
          base: { type: 'number', default: 0 }
        },
        init: function () {
          this.score = this.data.target;
        },
        tick: function () {
          this.el.addEventListener
          this.score.object3D.position.x = this.data.baseX + playerX;
        }
      });
      function getRnd(min, max) {
        return Math.floor(Math.random() * (max - min) ) + min;
      }
      AFRAME.registerComponent('clickable', {
        init: function () {
          var box = document.querySelector('#box');
          var score = document.querySelector('#score')

          var lastIndex = -1;
          var COLORS = ['red', 'green', 'blue'];
          this.el.addEventListener('click', function (evt) {
            lastIndex = (lastIndex + 1) % COLORS.length;
            this.setAttribute('material', 'color', COLORS[lastIndex]);
            box.object3D.position.x = getRnd(-10,10);
            box.object3D.position.y = getRnd(-10,10);
            
            let scoreText = score.getAttribute('text').value;
            const pattern = /\d/g;
            let result = parseInt(scoreText.match(pattern)) + 1;
            score.setAttribute('text', {value: `Score: ${result}`})
            console.log('Hit At: ', evt.detail.intersection.point);
          });
        }
      });
      AFRAME.registerComponent('aimbot', {
        init: function () {
          this.el.addEventListener('click', function (evt) {
            var aimbot = document.querySelector('#aimbot')
            aimbot.setAttribute('text', {value: `AIMBOT ON`})

            setTimeout(() => {
              console.log('AIMBOT ACTIVATED!!! :)')
              aimbot.setAttribute('text', {value: `:))) BYEEE!!`})
              location.reload();
            }, 4000);
          });
        }
      });
    document.addEventListener('DOMContentLoaded', function() {
      var sceneEl = document.querySelector('a-scene');
      var reticleEl = document.querySelector("#ret");
      var rayEl = document.querySelector("ray");
    });
    

    </script>
    <a-scene stats>
        <a-assets>
          <a-asset-item id="map" src="assets/models/city.glb"></a-asset-item>
          <a-asset-item id="sinon" src="assets/models/sinon_sniping.glb"></a-asset-item>
          <a-asset-item id="ball" src="assets/models/ball.glb"></a-asset-item>
          <audio id="sao_op" src="assets/sounds/sao_op.mp3" preload="auto"></audio>
          <audio id="shoot" src="assets/sounds/shoot.mp3" preload="auto"></audio>
          <img id="reticle" src="assets/images/reticle.png">
        </a-assets>

        <a-entity sound="src: #sao_op"></a-entity>
        <a-entity gltf-model="#map" position="1.6 -50 -0.8" rotation="0 200 0" scale="1 1 1"></a-entity>
        <a-sky color="#000"></a-sky>
        <a-plane class="aimbot" aimbot width="2" height="0.5" position="0 -5 -3" rotation="-75 0 0">
          <a-entity id="aimbot" text="value: aimbot; color: black; height: 5; width: 5; align: center" ></a-entity>
        </a-plane>

          <a-sphere material="shader:grid-glitch; color: blue;" radius="0.5" position="2 0 -5"></a-sphere>

        <a-entity id="player"
            position-reader
            nipple-controls="mode: static">
        <a-entity
            camera
            position="0 0.9 0"
            look-controls="true">
            <a-plane width="2" height="0.5" position="7.5 3.75 -5">
              <a-entity id="score" text="value: Score: 0; color: black; height: 5; width: 5; align: center" ></a-entity>
            </a-plane>
            <a-entity gltf-model="#sinon" animation-mixer="loop: repeat;" position="0 -1 0" scale="2 2 2" rotation="0 180 0"></a-entity>
            <a-entity
              id="ray"
              cursor="fuse: true;"
              raycaster="showLine: true; far: 50; lineColor: red; interval: 500; objects: .clickable, .aimbot;"
              material="color: red; shader: flat"
              position="0 0 0"
              rotation="0 0 0">

              <a-image id="ret" src="#reticle"
                      position="0 0 -10"
                      width="2.5"
                      height="2.5"
                      rotation="0 0 0"
                      material="src: #reticle; transparent: true; alphaTest: 0.01; depthTest: false;">
              </a-image>
            </a-entity>
          </a-entity>
        </a-entity>
<!-- -        <a-entity id="box" clickable geometry="primitive: box" material="color: blue" position="0 0 -2"></a-entity> -->
+        <a-entity id="box" class="clickable" clickable  geometry="primitive: box" material="shader:grid-glitch;" position="0 0 -10" sound="src: #shoot; volume= 2.0; on: click"></a-entity>
    </a-scene>
  </body>
</html>