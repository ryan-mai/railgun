<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Railgun</title>
    <meta name="description" content="Hello, World! - A-Frame">
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="DRACOLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="passwordGenerator.js"></script>
    <script src="anonGenerator.js"></script>
  </head>
  <body>

    <script>       
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        const auth = firebase.auth();
        auth.languageCode = 'it';

        auth.onAuthStateChanged((user) => {
            if (user) {
                try { localStorage.setItem('playerLoggedIn', 'true'); } catch (e) {}
                window.location.href = 'game.html';
            }
        });

    AFRAME.registerComponent('google-auth', {
        init: function() {
            this.el.addEventListener('click', async (e) => {
                try {
                    const result = await firebase.auth().signInWithPopup(provider);
                    const user = result.user;
                    const playername = prompt('[System] Enter your playername:', user.displayName || '');

                    const querySnapshot = await db.collection('Players').get();
                    let exists = false;
                    querySnapshot.forEach(doc => {
                        if (doc.data().name === playername) exists = true;
                    });

                    if (exists) {
                        alert('User already exists!');
                        return;
                    }

                    const rank = querySnapshot.size + 1;
                    const score = 0;
                    await db.collection('Players').add({ name: playername, score, rank });
                    try {
                        localStorage.setItem('playerLoggedIn', 'true');
                        localStorage.setItem('playerName', playername);
                        localStorage.setItem('playerScore', score);
                        localStorage.setItem('playerRank', rank);
                    } catch (e) {}
                    alert('[System] New Player Logged in | Username: ' + playername + ' | Score: ' + score + ' | Rank: ' + rank);
                    window.location.href = 'game.html';
                } catch (error) {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    const email = error.customData?.email;
                    const credential = firebase.auth.GoogleAuthProvider.credentialFromError(error);
                    console.error('Google sign-in error', errorCode, errorMessage, email, credential);
                }
            }, { once: true });
        }
    });

    AFRAME.registerComponent('user-auth', {
        init: function(){
            this.el.addEventListener('click', async (e) => { 
                var playername = document.querySelector('#userText').getAttribute('troika-text').value;
                if (playername.length > 0) {
                    const name = playername;
                    const password = generatePass();

                    const querySnapshot = await db.collection("Players").get();
                    let exists = false;
                    querySnapshot.forEach(doc => {
                        if (doc.data().name === name) exists = true;
                    });

                    if (exists) {
                        alert('User already exists!');
                        return;
                    }

                    const rank = querySnapshot.size + 1;
                    const score = 0;
                    await db.collection('Players').add({ name, password, score, rank });
                    // sign into Firebase (anonymous) so auth.onAuthStateChanged is triggered
                    try {
                        await auth.signInAnonymously();
                    } catch (e) {
                        console.warn('Anonymous sign-in failed after user creation:', e);
                    }
                    // set localStorage and move to game
                    try {
                        localStorage.setItem('playerLoggedIn', 'true');
                        localStorage.setItem('playerName', name);
                        // Persist score and rank so game.html can read them immediately after redirect
                        localStorage.setItem('playerScore', score);
                        localStorage.setItem('playerRank', rank);
                    } catch (e) {}
                    alert('[System] New Player Logged in | Username: ' + name + ' | Password: ' + password + ' | Score: ' + score + ' | Rank: ' + rank);
                    window.location.href = 'game.html';
                }
            });
        }
    }, { once: true });

    AFRAME.registerComponent('anon-auth', {
        init: function(){
            this.el.addEventListener('click', async (e) => { 
                // Call generateAnon and destructure the returned object
                const { name, password, score, rank, id } = await generateAnon();
                console.log( name, password, score, rank, id)
                try {
                    await auth.signInAnonymously();
                } catch (e) {
                    console.warn('Anonymous sign-in failed:', e);
                }
                // Persist useful values locally and navigate to the game
                try {
                    localStorage.setItem('playerLoggedIn', 'true');
                    localStorage.setItem('playerName', name);
                    localStorage.setItem('playerPassword', password);
                    localStorage.setItem('playerId', id);
                    // Persist score and rank from generateAnon
                    localStorage.setItem('playerScore', score);
                    localStorage.setItem('playerRank', rank);
                } catch (e) {}
                alert('[System] New Player Logged in | Username: ' + name + ' | Password: ' + password + ' | Score: ' + score + ' | Rank: ' + rank);
                setTimeout(() => { window.location.href = 'game.html'; }, 250);
            }, { once: true });
        }
    });
        
        AFRAME.registerComponent('clickable-key', {
        init: function () {
            this.el.addEventListener('click', async () => {
            var playername = document.querySelector('#userText');
            var currentText = playername.getAttribute('troika-text').value;
            const letterEl = this.el.querySelector('[troika-text]');
            const letter = letterEl.getAttribute('troika-text').value;
            let newText = currentText;
            
            if (letter === "Backspace" && currentText.length > 0) {
                newText = currentText.substring(0, currentText.length - 1);
            } else if (letter !== "Submit" && letter !== "Backspace") {
                newText = currentText + letter;
            }
            if (newText.length <= 13) {
                playername.setAttribute('troika-text', {
                value: newText,
                anchor: 'left'
                });
            } else {
                console.log("DELETE A LETTER BRUHH");
            };
        });
    }
    });
    </script>
    <a-scene stats>
      <a-assets>
        <a-asset-items>
            <a-asset-item id="futura" src="assets/fonts/futura_v2.ttf"></a-asset-item>
            <img id="reticle" src="assets/images/reticle.png">
            <img id="keycap" src="assets/images/keycap.png">
            <img id="login_bg" src="assets/images/user_login.png">
            <img id="backspace_bg" src="assets/images/backspace.png">
            <img id="submit_bg" src="assets/images/submit.png">
            <img id="google_bg" src="assets/images/google_login.png">
            <img id="skip_bg" src="assets/images/skip.png">
        </a-asset-items>
      </a-assets>
        <a-image id="clickable-keyboard" src="#login_bg" width="8" height="1.5" position="-5 4 -5">
            <a-entity troika-text="value: Player: ; color: white; fontSize:0.6" position="-2.2 0.04 0.01"></a-entity>
            <a-plane position="1.2 0 0.01" width="4.5" height="0.75" color="#FFF"></a-plane>
            <a-entity id="userText" troika-text="value:; color: black; fontSize:0.5" position="-0.8 -0.03 0.1"></a-entity>
            <a-entity troika-text="value: 13 Letters Only!; color: red; fontSize:0.25" position="2.75 -0.6 0.1"></a-entity>
        </a-image>
    <a-image id="userAuth"  src="#submit_bg" class="userAuth clickable-auth" width="4" height="1.5" user-auth position="3 4 -5" scale="-1 1 1">
            <a-entity troika-text="value: Submit; color: white; fontSize:0.5" position="0.1 -0.01 0.01" scale="-1 1 1"></a-entity>
        </a-image>
    <a-image id="googleAuth" src="#google_bg" class="googleAuth clickable-auth" width="1.5" height="1.5" google-auth position="0 4 -5">
        </a-image>
    <a-image id="anonAuth" src="#skip_bg" class="anonAuth clickable-auth" width="3.5" height="1.5" anon-auth position="7 4.1 -5">
            <a-entity troika-text="value: Skip Login; color: white; fontSize:0.3; anchor: left" position="-1.5 -0.1 0.01"></a-entity>  
        </a-image>      
        <a-plane id="keyboard">
        <a-image src="#keycap" class="clickable-key" clickable-key position="-6 2 -5">
            <a-entity troika-text="value: Q; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-4.75 2 -5">
            <a-entity troika-text="value: W; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-3.5 2 -5">
            <a-entity troika-text="value: E; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-2.25 2 -5">
            <a-entity troika-text="value: R; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-1 2 -5">
            <a-entity troika-text="value: T; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="0.25 2 -5">
            <a-entity troika-text="value: Y; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="1.5 2 -5">
            <a-entity troika-text="value: U; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="2.75 2 -5">
            <a-entity troika-text="value: I; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="4 2 -5">
            <a-entity troika-text="value: O; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="5.25 2 -5">
            <a-entity troika-text="value: P; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-5.33 0.5 -5">
            <a-entity troika-text="value: A; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-4.08 0.5 -5">
            <a-entity troika-text="value: S; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-2.83 0.5 -5">
            <a-entity troika-text="value: D; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-1.58 0.5 -5">
            <a-entity troika-text="value: F; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-0.33 0.5 -5">
            <a-entity troika-text="value: G; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="0.92 0.5 -5">
            <a-entity troika-text="value: H; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="2.17 0.5 -5">
            <a-entity troika-text="value: J; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="3.42 0.5 -5">
            <a-entity troika-text="value: K; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="4.67 0.5 -5">
            <a-entity troika-text="value: L; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-4.05 -1 -5">
            <a-entity troika-text="value: Z; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-2.8 -1 -5">
            <a-entity troika-text="value: X; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-1.55 -1 -5">
            <a-entity troika-text="value: C; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="-0.3 -1 -5">
            <a-entity troika-text="value: V; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="0.95 -1 -5">
            <a-entity troika-text="value: B; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="2.2 -1 -5">
            <a-entity troika-text="value: N; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#keycap" class="clickable-key" clickable-key position="3.45 -1 -5">
            <a-entity troika-text="value: M; color: white; fontSize:0.75" position="0.03 0.06 0.01"></a-entity>
        </a-image>
        <a-image src="#backspace_bg" class="clickable-key" width="4" height="4" clickable-key position="6.5 0.5 -5">
            <a-entity troika-text="value: Backspace; color: white; fontSize:0.5" position="0.5 -0.1 0.01"></a-entity>
        </a-image>
        <a-image src="#backspace_bg" class="clickable-key" width="4" height="4" clickable-key position="-7.15 0.5 -5" scale="-1 1 1">
            <a-entity troika-text="value: Backspace; color: white; fontSize:0.5" position="0.5 -0.1 0.01" scale="-1 1 1"></a-entity>
        </a-image>
        </a-plane>
        <a-sky color="#000"></a-sky>
        <a-entity id="player"
            position-reader
            nipple-controls="mode: static">
        <a-entity
            camera
            position="0 3 2"
            look-controls="true">
            <a-entity
              id="ray"
              cursor="fuse: true;"
              raycaster="showLine: true; far: 50; lineColor: red; interval: 500; objects: .clickable-key, .clickable-auth"
              material="color: red; shader: flat"
              position="0 0 0"
              rotation="0 0 0">

              <a-image id="ret" src="#reticle"
                      position="0 0 -10"
                      width="2.5"
                      height="2.5"
                      rotation="0 0 0"
                      material="src: #reticle; transparent: true; alphaTest: 0.01; depthTest: false;">
              </a-image>
            </a-entity>
          </a-entity>
        </a-entity>
    </a-scene>
  </body>
</html>