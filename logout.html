<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Logout - Railgun</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; display:flex; align-items:center; justify-content:center; height:100vh; margin:0; background:#111; color:#eee }
      .card { background:#1b1b1b; padding:24px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.6); width:320px; text-align:center }
      button { padding:10px 16px; font-size:16px; border:none; border-radius:6px; cursor:pointer }
      .danger { background:#c0392b; color:white }
      .soft { background:#3498db; color:white }
      .info { margin-bottom:12px; font-size:14px }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Log Out</h2>
      <div class="info" id="who">Loading...</div>
    <!-- <div class="info" id="count">Logout visits: -999</div> -->
      <button id="logoutBtn" class="soft">Logout</button>
      <div style="height:12px;"></div>
    </div>

    <script>
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      function refreshInfo() {
        const name = localStorage.getItem('playerName') || 'Null';
        const user = firebase.auth().currentUser;
        const signed = user ? (user.isAnonymous ? 'Anonymous' : 'Signed-in') : 'Not signed-in';
        document.getElementById('who').textContent = `Player: ${name}`;
      }


  function getVisitorId(user) {
        if (user && user.uid) return user.uid;
        const stored = localStorage.getItem('playerId');
        if (stored) return stored;

        let anon = localStorage.getItem('anonVisitorId');
        if (!anon) {
          anon = 'anon_' + Math.random().toString(36).slice(2, 10);
          localStorage.setItem('anonVisitorId', anon);
        }
        return anon;
      }

      async function incrementLogoutCount(user) {
        try {
          const vid = getVisitorId(user);
          const docRef = db.collection('logoutCounts').doc(vid);
          await docRef.set({ count: firebase.firestore.FieldValue.increment(1), last: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
          const snap = await docRef.get();
          const count = snap.exists ? (snap.data().count || 0) : 0;
        //   document.getElementById('count').textContent = `Attempts: ${count}`;
        } catch (err) {
          console.error('Failed to increment logout count', err);
          document.getElementById('count').textContent = 'Logout visits: (error)';
        }
      }

      let _counted = false;
      auth.onAuthStateChanged((user) => {
        refreshInfo();
        if (!_counted) {
          _counted = true;
          incrementLogoutCount(user);
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', () => window.location.href ='game.html');
      refreshInfo();
    </script>
  </body>
</html>
